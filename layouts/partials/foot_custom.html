<script defer src="//yihui.org/js/math-code.js"></script>
<script src="//cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script defer src="//yihui.org/js/center-img.js"></script>
<script src="//unpkg.com/littlefoot/dist/littlefoot.js" defer></script>

<script defer>
document.addEventListener('DOMContentLoaded', function () {
  // Safety guard so one error doesn't kill everything
  try {
    // 1) Initialise littlefoot if present
    if (window.littlefoot && typeof littlefoot.default === 'function') {
      try { littlefoot.default(); } catch (_) {}
    }

    // 2) Find sensible content containers across your layouts
    var containers = document.querySelectorAll('main, .content, article, .page, .single, .post');
    if (!containers.length) containers = [document.body];

    // 3) Tag blocks: use .children to avoid the broken '> *' selector
    function tagBlocks(root) {
      var scopes = root ? [root] : Array.from(containers);

      scopes.forEach(function (scope) {
        if (scope.closest && scope.closest('header, nav, footer')) return;

        // Direct blocks under the scope
        Array.from(scope.children || []).forEach(function (el) {
          if (!el.closest('header, nav, footer')) el.classList.add('reveal');
        });

        // Common descendants that often carry the content
        var more = scope.querySelectorAll([
          'p','li','h1','h2','h3','h4','figure','blockquote','section','img','a',
          'table','thead','tbody > tr','caption'
        ].join(','));
        more.forEach(function (el) {
          if (!el.closest('header, nav, footer')) el.classList.add('reveal');
        });
      });
    }

    // 4) Reveal logic with IntersectionObserver
    var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    var io = null;

    function makeVisible(el){ el.classList.add('is-visible'); }

    function attachObserver() {
      if (reduce || !('IntersectionObserver' in window)) {
        document.querySelectorAll('.reveal').forEach(makeVisible);
        return;
      }
      io = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            makeVisible(entry.target);
            io.unobserve(entry.target);
          }
        });
      }, { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.1 });

      document.querySelectorAll('.reveal:not(.is-visible)').forEach(function (el) {
        io.observe(el);
      });
    }

    // Initial pass
    tagBlocks();
    attachObserver();

    // 5) Handle late DOM changes
    var scheduled = false;
    function schedule() {
      if (scheduled) return;
      scheduled = true;
      requestAnimationFrame(function () {
        scheduled = false;
        tagBlocks();
        if (io) {
          document.querySelectorAll('.reveal:not(.is-visible)').forEach(function (el) {
            io.observe(el);
          });
        } else {
          document.querySelectorAll('.reveal').forEach(makeVisible);
        }
      });
    }

    new MutationObserver(function (muts) {
      for (var m of muts) { if (m.addedNodes && m.addedNodes.length) { schedule(); break; } }
    }).observe(document.body, { childList: true, subtree: true });

    if (window.MathJax && MathJax.startup && MathJax.startup.promise) {
      MathJax.startup.promise.then(schedule).catch(function(){});
    }
  } catch (e) {
    console.error('fade-in init failed:', e);
  }
});
</script>
