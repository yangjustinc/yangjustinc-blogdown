<script defer src="//yihui.org/js/math-code.js"></script>
<script src="//cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script defer src="//yihui.org/js/center-img.js"></script>

<!-- littlefoot -->
<script src="//unpkg.com/littlefoot/dist/littlefoot.js" defer></script>

<!-- AOS -->
<script src="//unpkg.com/aos@2.3.4/dist/aos.js" defer></script>

<script defer>
document.addEventListener('DOMContentLoaded', function () {
  // 1. Initialise littlefoot safely
  if (window.littlefoot && typeof littlefoot.default === 'function') {
    try { littlefoot.default(); } catch (e) { console.warn('littlefoot init failed:', e); }
  }

  // 2. Tag logical content blocks for fade-in
  function tagBlocks(root) {
    var scope = root || document;
    var blocks = scope.querySelectorAll([
      'main > *', '.content > *', 'article > *',
      'main table','main table > tbody > tr','main table > thead',
      '.content table','.content table > tbody > tr','.content table > thead',
      'body .page > *','body .single > *','body .post > *'
    ].join(','));

    blocks.forEach(function (el) {
      if (el.closest('header, nav, footer')) return;
      if (!el.hasAttribute('data-aos')) {
        el.setAttribute('data-aos', 'fade-up');
        el.setAttribute('data-aos-anchor-placement', 'top-bottom');
      }
    });
  }

  tagBlocks();

  // 3. Initialise AOS with gentle reduced-motion handling
  var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (window.AOS && typeof AOS.init === 'function') {
    AOS.init({
      disable: false,
      once: true,
      offset: reduce ? 0 : 60,
      duration: reduce ? 200 : 500,   // short but visible fade
      easing: reduce ? 'linear' : 'ease-in-out'
    });
  }

  // 4. Re-tag and refresh if content changes dynamically
  var scheduled = false;
  function schedule() {
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(function () {
      scheduled = false;
      tagBlocks();
      if (window.AOS && typeof AOS.refreshHard === 'function') AOS.refreshHard();
    });
  }
  new MutationObserver(function (muts) {
    for (var m of muts) {
      if (m.addedNodes && m.addedNodes.length) { schedule(); break; }
    }
  }).observe(document.body, { childList: true, subtree: true });

  // 5. Refresh AOS after MathJax finishes typesetting
  if (window.MathJax && MathJax.startup && MathJax.startup.promise) {
    MathJax.startup.promise.then(function () {
      if (window.AOS && typeof AOS.refreshHard === 'function') AOS.refreshHard();
    }).catch(function(){});
  }
});
</script>
