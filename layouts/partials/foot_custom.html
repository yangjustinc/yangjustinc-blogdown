<script defer src="//yihui.org/js/math-code.js"></script>
<script src="//cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script defer src="//yihui.org/js/center-img.js"></script>

<!-- littlefoot (kept) -->
<script src="//unpkg.com/littlefoot/dist/littlefoot.js" defer></script>

<script defer>
document.addEventListener('DOMContentLoaded', function () {
  // Initialise littlefoot safely
  if (window.littlefoot && typeof littlefoot.default === 'function') {
    try { littlefoot.default(); } catch (e) { console.warn('littlefoot init failed:', e); }
  }

  // Pick sensible containers across xmin pages
  var containers = document.querySelectorAll('main, .content, article, .page, .single, .post');
  if (!containers.length) containers = [document.body];

  // Tag logical blocks rather than every tiny node
  function tagBlocks(root) {
    var scopes = root ? [root] : Array.from(containers);
    var sel = [
      // direct blocks
      '> *',
      // tables and rows for pages like Teaching
      'table', 'table > thead', 'table > tbody > tr',
      // typical content for pages like Publications
      'p', 'li', 'h1', 'h2', 'h3', 'h4', 'figure', 'blockquote', 'section', 'a'
    ];

    scopes.forEach(function (scope) {
      // Skip header/nav/footer areas
      if (scope.closest && scope.closest('header, nav, footer')) return;

      var nodes = scope.querySelectorAll(sel.join(','));
      nodes.forEach(function (el) {
        if (el.closest('header, nav, footer')) return;
        if (!el.classList.contains('reveal')) el.classList.add('reveal');
      });
    });
  }

  // IntersectionObserver fade-in
  var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  var io = null;

  function setupObserver() {
    if (reduce) {
      // Show immediately, still with gentle opacity transition from CSS
      document.querySelectorAll('.reveal').forEach(function (el) {
        el.classList.add('is-visible');
      });
      return;
    }
    if (!('IntersectionObserver' in window)) {
      document.querySelectorAll('.reveal').forEach(function (el) {
        el.classList.add('is-visible');
      });
      return;
    }
    io = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          io.unobserve(entry.target);
        }
      });
    }, { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.1 });

    document.querySelectorAll('.reveal').forEach(function (el) { io.observe(el); });
  }

  // Initial tag + observe
  tagBlocks();
  setupObserver();

  // Refresh when content changes (e.g., shortcodes, tables)
  var scheduled = false;
  function schedule() {
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(function () {
      scheduled = false;
      tagBlocks();
      if (io) {
        document.querySelectorAll('.reveal:not(.is-visible)').forEach(function (el) { io.observe(el); });
      } else {
        // Reduced motion or no IO
        document.querySelectorAll('.reveal').forEach(function (el) { el.classList.add('is-visible'); });
      }
    });
  }
  new MutationObserver(function (muts) {
    for (var m of muts) { if (m.addedNodes && m.addedNodes.length) { schedule(); break; } }
  }).observe(document.body, { childList: true, subtree: true });

  // After MathJax typesets, reveal anything newly sized
  if (window.MathJax && MathJax.startup && MathJax.startup.promise) {
    MathJax.startup.promise.then(schedule).catch(function(){});
  }
});
</script>
